<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥å–®è¨ˆæ™‚ç³»çµ± - å“¡å·¥ç‰ˆ</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    /* ç™»å…¥ç•«é¢ */
    .login-screen {
      max-width: 500px;
      margin: 50px auto;
      text-align: center;
    }

    .login-screen h1 {
      color: #667eea;
      margin-bottom: 30px;
      font-size: 32px;
    }

    .login-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #ddd;
    }

    .login-tab {
      flex: 1;
      padding: 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .login-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .login-content {
      display: none;
    }

    .login-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    input[type="text"], select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ä½¿ç”¨è€…è³‡è¨Šå¡ç‰‡ */
    .user-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-details {
      flex: 1;
    }

    .user-details h3 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .user-details p {
      opacity: 0.9;
      margin: 3px 0;
    }

    .btn-logout {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
    }

    .btn-logout:hover {
      background: rgba(255,255,255,0.3);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      flex-wrap: wrap;
    }

    .tab {
      padding: 15px 30px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-start {
      background: #4CAF50;
      color: white;
    }

    .btn-start:hover {
      background: #45a049;
    }

    .btn-stop {
      background: #f44336;
      color: white;
    }

    .btn-stop:hover {
      background: #da190b;
    }

    .btn-export {
      background: #2196F3;
      color: white;
    }

    .btn-export:hover {
      background: #0b7dda;
    }

    .btn-clear {
      background: #ff9800;
      color: white;
    }

    #reader {
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
      max-width: 100%;
    }

    .status {
      padding: 15px;
      background: #f0f0f0;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .status.scanning {
      background: #fff3cd;
      color: #856404;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .barcode-generator {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .barcode-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .barcode-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #ddd;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .barcode-item h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .barcode-item svg {
      margin: 15px 0;
      max-width: 100%;
    }

    .barcode-item button {
      width: 100%;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      overflow-x: auto;
      display: block;
    }

    thead, tbody {
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      word-wrap: break-word;
    }

    th {
      background: #667eea;
      color: white;
      font-weight: bold;
    }

    tr:hover {
      background: #f5f5f5;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      animation: slideIn 0.3s;
      margin: 20px;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal h2 {
      margin-bottom: 20px;
      color: #333;
    }

    .modal p {
      font-size: 18px;
      margin: 15px 0;
      color: #666;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      justify-content: center;
    }

    .modal button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .print-area {
      display: none;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .print-area, .print-area * {
        visibility: visible;
      }
      .print-area {
        position: absolute;
        left: 0;
        top: 0;
        display: block;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .tab {
        padding: 10px 15px;
        font-size: 14px;
      }

      button {
        padding: 10px 15px;
        font-size: 14px;
      }

      .modal-content {
        padding: 30px 20px;
      }

      th, td {
        padding: 8px;
        font-size: 14px;
      }

      .user-info {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥ç•«é¢ -->
  <div id="loginScreen" class="login-screen">
    <h1>ğŸ‘¤ å“¡å·¥ç™»å…¥</h1>
    
    <div class="login-tabs">
      <button class="login-tab active" onclick="switchLoginTab('manual')">ğŸ“ æ‰‹å‹•è¼¸å…¥</button>
      <button class="login-tab" onclick="switchLoginTab('scan')">ğŸ“· æƒææ¢ç¢¼</button>
    </div>

    <!-- æ‰‹å‹•è¼¸å…¥ç™»å…¥ -->
    <div id="manualLogin" class="login-content active">
      <div class="form-group">
        <label>å“¡å·¥å·¥è™Ÿ *</label>
        <input type="text" id="empId" placeholder="ä¾‹å¦‚: E001">
      </div>
      <div class="form-group">
        <label>éƒ¨é–€ä»£è™Ÿ *</label>
        <select id="deptCode">
          <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
          <option value="PROD">ç”Ÿç”¢éƒ¨ (PROD)</option>
          <option value="QC">å“ç®¡éƒ¨ (QC)</option>
          <option value="MAINT">ç¶­ä¿®éƒ¨ (MAINT)</option>
          <option value="PACK">åŒ…è£éƒ¨ (PACK)</option>
          <option value="SHIP">å‡ºè²¨éƒ¨ (SHIP)</option>
        </select>
      </div>
      <div class="form-group">
        <label>å“¡å·¥å§“å *</label>
        <input type="text" id="empName" placeholder="ä¾‹å¦‚: ç‹å°æ˜">
      </div>
      <button class="btn-primary" onclick="manualLogin()" style="width: 100%; margin-top: 20px;">
        âœ“ ç™»å…¥ç³»çµ±
      </button>
    </div>

    <!-- æƒææ¢ç¢¼ç™»å…¥ -->
    <div id="scanLogin" class="login-content">
      <div class="status" id="loginStatus">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æƒæå“¡å·¥è­‰</div>
      <button class="btn-start" onclick="startEmployeeScanner()" style="width: 100%; margin-bottom: 10px;">
        ğŸ“· é–‹å§‹æƒæå“¡å·¥è­‰
      </button>
      <button class="btn-stop" onclick="stopEmployeeScanner()" style="width: 100%;">
        â¹ï¸ åœæ­¢æƒæ
      </button>
      <div id="loginReader" style="margin-top: 20px;"></div>
    </div>
  </div>

  <!-- ä¸»ç³»çµ±ç•«é¢ -->
  <div id="mainApp" class="container" style="display: none;">
    <!-- å“¡å·¥è³‡è¨Šå¡ç‰‡ -->
    <div class="user-info">
      <div class="user-details">
        <h3 id="displayName">ç‹å°æ˜</h3>
        <p id="displayEmpId">å·¥è™Ÿ: E001</p>
        <p id="displayDept">éƒ¨é–€: ç”Ÿç”¢éƒ¨ (PROD)</p>
      </div>
      <button class="btn-logout" onclick="logout()">ğŸšª ç™»å‡º</button>
    </div>

    <h1>ğŸ“¦ å·¥å–®è¨ˆæ™‚ç³»çµ±</h1>
    <p class="subtitle">å“¡å·¥ç‰ˆ - å«æ¢ç¢¼ç”Ÿæˆå™¨</p>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('generate')">ğŸ·ï¸ ç”Ÿæˆæ¢ç¢¼</button>
      <button class="tab" onclick="switchTab('scan')">ğŸ“· æƒæè¨ˆæ™‚</button>
      <button class="tab" onclick="switchTab('records')">ğŸ“Š å·¥ä½œè¨˜éŒ„</button>
      <button class="tab" onclick="switchTab('empBarcode')">ğŸ‘¤ å“¡å·¥æ¢ç¢¼</button>
    </div>

    <!-- ç”Ÿæˆå·¥å–®æ¢ç¢¼ -->
    <div id="generate" class="tab-content active">
      <div class="barcode-generator">
        <h2>ç”¢ç”Ÿæ¸¬è©¦æ¢ç¢¼</h2>
        <div class="form-group">
          <label>å·¥å–®è™Ÿç¢¼:</label>
          <input type="text" id="workOrderInput" placeholder="ä¾‹å¦‚: WO20240204001">
        </div>
        <button class="btn-primary" onclick="generateBarcode()">ç”Ÿæˆæ¢ç¢¼</button>
        <button class="btn-primary" onclick="generateMultiple()">ç”Ÿæˆ5å€‹æ¸¬è©¦æ¢ç¢¼</button>
      </div>
      <div id="barcodeList" class="barcode-list"></div>
    </div>

    <!-- æƒæå·¥å–®è¨ˆæ™‚ -->
    <div id="scan" class="tab-content">
      <div class="controls">
        <button class="btn-start" onclick="requestCameraAndStart()">ğŸ¥ é–‹å§‹æƒæ</button>
        <button class="btn-stop" onclick="stopScanner()">â¹ï¸ åœæ­¢æƒæ</button>
      </div>
      <div class="status" id="status">è«‹é»æ“Šã€Œé–‹å§‹æƒæã€ä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™</div>
      <div id="reader"></div>
    </div>

    <!-- å·¥ä½œè¨˜éŒ„ -->
    <div id="records" class="tab-content">
      <div class="controls">
        <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
        <button class="btn-clear" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™</button>
      </div>
      <div id="recordsTable"></div>
    </div>

    <!-- å“¡å·¥æ¢ç¢¼ç”Ÿæˆ -->
    <div id="empBarcode" class="tab-content">
      <div class="barcode-generator">
        <h2>ç”¢ç”Ÿå“¡å·¥æ¢ç¢¼</h2>
        <p style="color: #666; margin-bottom: 20px;">
          å“¡å·¥æ¢ç¢¼æ ¼å¼: EMP-å·¥è™Ÿ-éƒ¨é–€-å§“å<br>
          ä¾‹å¦‚: EMP-E001-PROD-ç‹å°æ˜
        </p>
        <div class="form-group">
          <label>å“¡å·¥å·¥è™Ÿ:</label>
          <input type="text" id="empBarcodeId" placeholder="ä¾‹å¦‚: E001">
        </div>
        <div class="form-group">
          <label>éƒ¨é–€ä»£è™Ÿ:</label>
          <select id="empBarcodeDept">
            <option value="PROD">ç”Ÿç”¢éƒ¨ (PROD)</option>
            <option value="QC">å“ç®¡éƒ¨ (QC)</option>
            <option value="MAINT">ç¶­ä¿®éƒ¨ (MAINT)</option>
            <option value="PACK">åŒ…è£éƒ¨ (PACK)</option>
            <option value="SHIP">å‡ºè²¨éƒ¨ (SHIP)</option>
          </select>
        </div>
        <div class="form-group">
          <label>å“¡å·¥å§“å:</label>
          <input type="text" id="empBarcodeName" placeholder="ä¾‹å¦‚: ç‹å°æ˜">
        </div>
        <button class="btn-primary" onclick="generateEmployeeBarcode()">ç”Ÿæˆå“¡å·¥æ¢ç¢¼</button>
      </div>
      <div id="empBarcodeList" class="barcode-list"></div>
    </div>
  </div>

  <!-- ç¢ºèªå°è©±æ¡† -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h2 id="modalTitle"></h2>
      <p id="modalWorkOrder"></p>
      <p id="modalTime"></p>
      <p id="modalEmployee"></p>
      <div class="modal-buttons">
        <button class="btn-start" onclick="confirmAction(true)">âœ“ ç¢ºèª</button>
        <button class="btn-stop" onclick="confirmAction(false)">âœ— å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div class="print-area" id="printArea"></div>

  <script>
    let html5QrCode;
    let employeeScanner;
    let workRecords = [];
    let currentScan = null;
    let generatedBarcodes = [];
    let employeeBarcodes = [];
    let isScanning = false;
    let isEmployeeScanning = false;
    let currentUser = null;

    // ========== ç™»å…¥ç›¸é—œ ==========
    function switchLoginTab(tabName) {
      document.querySelectorAll('.login-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.login-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      document.getElementById(tabName === 'manual' ? 'manualLogin' : 'scanLogin').classList.add('active');
      event.target.classList.add('active');

      // åˆ‡æ›åˆ°æƒææ™‚åœæ­¢ä¹‹å‰çš„æƒæå™¨
      if (tabName === 'manual' && isEmployeeScanning) {
        stopEmployeeScanner();
      }
    }

    function manualLogin() {
      const empId = document.getElementById('empId').value.trim();
      const deptCode = document.getElementById('deptCode').value;
      const empName = document.getElementById('empName').value.trim();

      if (!empId || !deptCode || !empName) {
        alert('âŒ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½!');
        return;
      }

      performLogin(empId, deptCode, empName);
    }

    async function startEmployeeScanner() {
      const statusEl = document.getElementById('loginStatus');
      
      if (isEmployeeScanning) {
        statusEl.textContent = 'æƒæå™¨å·²ç¶“åœ¨é‹è¡Œä¸­';
        return;
      }

      try {
        statusEl.textContent = 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...';
        statusEl.className = 'status scanning';

        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        stream.getTracks().forEach(track => track.stop());

        employeeScanner = new Html5Qrcode("loginReader");
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        };

        await employeeScanner.start(
          { facingMode: "environment" },
          config,
          onEmployeeScanSuccess,
          () => {} // å¿½ç•¥éŒ¯èª¤
        );

        isEmployeeScanning = true;
        statusEl.textContent = 'âœ… æƒæä¸­...è«‹å°æº–å“¡å·¥è­‰æ¢ç¢¼';
        statusEl.className = 'status success';
        
      } catch (err) {
        console.error('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', err);
        statusEl.textContent = `âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: ${err.message}`;
        statusEl.className = 'status error';
      }
    }

    function stopEmployeeScanner() {
      if (employeeScanner && isEmployeeScanning) {
        employeeScanner.stop().then(() => {
          document.getElementById('loginStatus').textContent = 'å·²åœæ­¢æƒæ';
          document.getElementById('loginStatus').className = 'status';
          isEmployeeScanning = false;
        });
      }
    }

    function onEmployeeScanSuccess(decodedText) {
      console.log("æƒæåˆ°å“¡å·¥è­‰:", decodedText);
      stopEmployeeScanner();

      // è§£æå“¡å·¥æ¢ç¢¼æ ¼å¼: EMP-E001-PROD-ç‹å°æ˜
      if (decodedText.startsWith('EMP-')) {
        const parts = decodedText.split('-');
        if (parts.length === 4) {
          const empId = parts[1];
          const deptCode = parts[2];
          const empName = parts[3];
          performLogin(empId, deptCode, empName);
        } else {
          alert('âŒ å“¡å·¥æ¢ç¢¼æ ¼å¼éŒ¯èª¤!');
        }
      } else {
        alert('âŒ é€™ä¸æ˜¯æœ‰æ•ˆçš„å“¡å·¥æ¢ç¢¼!');
      }
    }

    function performLogin(empId, deptCode, empName) {
      currentUser = {
        empId: empId,
        deptCode: deptCode,
        empName: empName,
        loginTime: new Date().toISOString()
      };

      // å„²å­˜ç™»å…¥è³‡è¨Š
      localStorage.setItem('currentUser', JSON.stringify(currentUser));

      // é¡¯ç¤ºä¸»ç³»çµ±
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';

      // æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º
      updateUserDisplay();

      // è¼‰å…¥è³‡æ–™
      loadData();

      alert(`âœ“ æ­¡è¿ ${empName}!`);
    }

    function updateUserDisplay() {
      if (!currentUser) return;

      const deptNames = {
        'PROD': 'ç”Ÿç”¢éƒ¨',
        'QC': 'å“ç®¡éƒ¨',
        'MAINT': 'ç¶­ä¿®éƒ¨',
        'PACK': 'åŒ…è£éƒ¨',
        'SHIP': 'å‡ºè²¨éƒ¨'
      };

      document.getElementById('displayName').textContent = currentUser.empName;
      document.getElementById('displayEmpId').textContent = `å·¥è™Ÿ: ${currentUser.empId}`;
      document.getElementById('displayDept').textContent = 
        `éƒ¨é–€: ${deptNames[currentUser.deptCode] || currentUser.deptCode} (${currentUser.deptCode})`;
    }

    function logout() {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—?')) {
        // åœæ­¢æ‰€æœ‰æƒæå™¨
        if (isScanning) stopScanner();
        if (isEmployeeScanning) stopEmployeeScanner();

        // æ¸…é™¤ç™»å…¥è³‡è¨Š
        currentUser = null;
        localStorage.removeItem('currentUser');

        // é¡¯ç¤ºç™»å…¥ç•«é¢
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';

        // æ¸…ç©ºè¼¸å…¥æ¬„ä½
        document.getElementById('empId').value = '';
        document.getElementById('deptCode').value = '';
        document.getElementById('empName').value = '';
      }
    }

    // ========== åˆ†é åˆ‡æ› ==========
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'records') {
        displayRecords();
      } else if (tabName === 'empBarcode') {
        displayEmployeeBarcodes();
      }
    }

    // ========== å·¥å–®æ¢ç¢¼ç”Ÿæˆ ==========
    function generateBarcode() {
      const input = document.getElementById('workOrderInput');
      const workOrderNo = input.value.trim();

      if (!workOrderNo) {
        alert('è«‹è¼¸å…¥å·¥å–®è™Ÿ!');
        return;
      }

      addBarcodeToList(workOrderNo);
      input.value = '';
    }

    function generateMultiple() {
      const today = new Date();
      const dateStr = today.getFullYear() + 
                     String(today.getMonth() + 1).padStart(2, '0') + 
                     String(today.getDate()).padStart(2, '0');

      for (let i = 1; i <= 5; i++) {
        const workOrderNo = `WO${dateStr}${String(i).padStart(3, '0')}`;
        addBarcodeToList(workOrderNo);
      }
    }

    function addBarcodeToList(workOrderNo) {
      if (generatedBarcodes.includes(workOrderNo)) {
        alert('æ­¤å·¥å–®è™Ÿå·²ç¶“ç”Ÿæˆéäº†!');
        return;
      }

      generatedBarcodes.push(workOrderNo);
      displayBarcodes();
    }

    function displayBarcodes() {
      const container = document.getElementById('barcodeList');
      
      if (generatedBarcodes.length === 0) {
        container.innerHTML = '<div class="empty-state">å°šæœªç”Ÿæˆä»»ä½•æ¢ç¢¼</div>';
        return;
      }

      container.innerHTML = '';

      generatedBarcodes.forEach((workOrderNo, index) => {
        const div = document.createElement('div');
        div.className = 'barcode-item';
        div.innerHTML = `
          <h3>å·¥å–® #${index + 1}</h3>
          <svg id="barcode-${index}"></svg>
          <p><strong>${workOrderNo}</strong></p>
          <button class="btn-primary" onclick="printBarcode(${index}, 'work')">ğŸ–¨ï¸ åˆ—å°æ­¤æ¢ç¢¼</button>
          <button class="btn-stop" onclick="removeBarcode(${index})">ğŸ—‘ï¸ åˆªé™¤</button>
        `;
        container.appendChild(div);

        JsBarcode(`#barcode-${index}`, workOrderNo, {
          format: "CODE128",
          width: 2,
          height: 80,
          displayValue: true,
          fontSize: 16,
          margin: 10
        });
      });
      
      saveData();
    }

    function removeBarcode(index) {
      generatedBarcodes.splice(index, 1);
      displayBarcodes();
    }

    function printBarcode(index, type) {
      const printArea = document.getElementById('printArea');
      let barcodeData, title;

      if (type === 'work') {
        barcodeData = generatedBarcodes[index];
        title = 'å·¥å–®æ¢ç¢¼';
      } else {
        barcodeData = employeeBarcodes[index];
        title = 'å“¡å·¥æ¢ç¢¼';
      }
      
      printArea.innerHTML = `
        <div style="text-align: center; padding: 50px;">
          <h2>${title}</h2>
          <svg id="print-barcode"></svg>
          <p style="margin-top: 20px; font-size: 18px;">${barcodeData}</p>
        </div>
      `;

      JsBarcode('#print-barcode', barcodeData, {
        format: "CODE128",
        width: 3,
        height: 100,
        displayValue: true,
        fontSize: 20,
        margin: 20
      });

      window.print();
    }

    // ========== å“¡å·¥æ¢ç¢¼ç”Ÿæˆ ==========
    function generateEmployeeBarcode() {
      const empId = document.getElementById('empBarcodeId').value.trim();
      const deptCode = document.getElementById('empBarcodeDept').value;
      const empName = document.getElementById('empBarcodeName').value.trim();

      if (!empId || !deptCode || !empName) {
        alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½!');
        return;
      }

      // å“¡å·¥æ¢ç¢¼æ ¼å¼: EMP-å·¥è™Ÿ-éƒ¨é–€-å§“å
      const empBarcode = `EMP-${empId}-${deptCode}-${empName}`;

      if (employeeBarcodes.includes(empBarcode)) {
        alert('æ­¤å“¡å·¥æ¢ç¢¼å·²ç¶“ç”Ÿæˆéäº†!');
        return;
      }

      employeeBarcodes.push(empBarcode);
      displayEmployeeBarcodes();

      // æ¸…ç©ºè¼¸å…¥
      document.getElementById('empBarcodeId').value = '';
      document.getElementById('empBarcodeName').value = '';
    }

    function displayEmployeeBarcodes() {
      const container = document.getElementById('empBarcodeList');
      
      if (employeeBarcodes.length === 0) {
        container.innerHTML = '<div class="empty-state">å°šæœªç”Ÿæˆä»»ä½•å“¡å·¥æ¢ç¢¼</div>';
        return;
      }

      container.innerHTML = '';

      employeeBarcodes.forEach((empBarcode, index) => {
        const parts = empBarcode.split('-');
        const empId = parts[1];
        const deptCode = parts[2];
        const empName = parts[3];

        const div = document.createElement('div');
        div.className = 'barcode-item';
        div.innerHTML = `
          <h3>${empName}</h3>
          <svg id="emp-barcode-${index}"></svg>
          <p><strong>å·¥è™Ÿ:</strong> ${empId}</p>
          <p><strong>éƒ¨é–€:</strong> ${deptCode}</p>
          <button class="btn-primary" onclick="printBarcode(${index}, 'emp')">ğŸ–¨ï¸ åˆ—å°æ¢ç¢¼</button>
          <button class="btn-stop" onclick="removeEmployeeBarcode(${index})">ğŸ—‘ï¸ åˆªé™¤</button>
        `;
        container.appendChild(div);

        JsBarcode(`#emp-barcode-${index}`, empBarcode, {
          format: "CODE128",
          width: 2,
          height: 80,
          displayValue: true,
          fontSize: 14,
          margin: 10
        });
      });
      
      saveData();
    }

    function removeEmployeeBarcode(index) {
      employeeBarcodes.splice(index, 1);
      displayEmployeeBarcodes();
    }

    // ========== å·¥å–®æƒæè¨ˆæ™‚ ==========
    async function requestCameraAndStart() {
      const statusEl = document.getElementById('status');
      
      if (isScanning) {
        statusEl.textContent = 'æƒæå™¨å·²ç¶“åœ¨é‹è¡Œä¸­';
        statusEl.className = 'status';
        return;
      }

      try {
        statusEl.textContent = 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...';
        statusEl.className = 'status scanning';

        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        stream.getTracks().forEach(track => track.stop());

        await startScanner();
        
      } catch (err) {
        console.error('ç›¸æ©ŸéŒ¯èª¤:', err);
        statusEl.className = 'status error';
        
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          statusEl.textContent = 'âŒ ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•!è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™';
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
          statusEl.textContent = 'âŒ æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          statusEl.textContent = 'âŒ ç›¸æ©Ÿæ­£åœ¨è¢«å…¶ä»–æ‡‰ç”¨ä½¿ç”¨';
        } else {
          statusEl.textContent = `âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: ${err.message}`;
        }
      }
    }

    async function startScanner() {
      const statusEl = document.getElementById('status');
      
      try {
        html5QrCode = new Html5Qrcode("reader");
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        };

        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          () => {} // å¿½ç•¥æƒæéŒ¯èª¤
        );

        isScanning = true;
        statusEl.textContent = 'âœ… æƒæä¸­...è«‹å°æº–æ¢ç¢¼';
        statusEl.className = 'status success';
        
      } catch (err) {
        console.error('å•Ÿå‹•æƒæå™¨å¤±æ•—:', err);
        statusEl.textContent = `âŒ å•Ÿå‹•å¤±æ•—: ${err}`;
        statusEl.className = 'status error';
        isScanning = false;
      }
    }

    function stopScanner() {
      if (html5QrCode && isScanning) {
        html5QrCode.stop().then(() => {
          document.getElementById('status').textContent = 'å·²åœæ­¢æƒæ';
          document.getElementById('status').className = 'status';
          isScanning = false;
        }).catch(err => {
          console.error('åœæ­¢æƒæå™¨å¤±æ•—:', err);
          isScanning = false;
        });
      }
    }

    function onScanSuccess(decodedText) {
      console.log("æƒæåˆ°:", decodedText);
      
      // å¦‚æœæƒåˆ°å“¡å·¥æ¢ç¢¼,å¿½ç•¥
      if (decodedText.startsWith('EMP-')) {
        alert('é€™æ˜¯å“¡å·¥æ¢ç¢¼,è«‹æƒæå·¥å–®æ¢ç¢¼!');
        return;
      }

      stopScanner();
      
      const existingRecord = workRecords.find(r => 
        r.workOrderNo === decodedText && !r.endTime
      );

      currentScan = {
        workOrderNo: decodedText,
        isStart: !existingRecord
      };

      showModal(decodedText, !existingRecord);
    }

    function showModal(workOrderNo, isStart) {
      const modal = document.getElementById('modal');
      const title = document.getElementById('modalTitle');
      const workOrder = document.getElementById('modalWorkOrder');
      const time = document.getElementById('modalTime');
      const employee = document.getElementById('modalEmployee');

      const now = new Date();
      const timeStr = formatDateTime(now);

      if (isStart) {
        title.textContent = 'â±ï¸ é–‹å§‹å·¥ä½œ?';
        workOrder.textContent = `å·¥å–®è™Ÿ: ${workOrderNo}`;
        time.textContent = `é–‹å§‹æ™‚é–“: ${timeStr}`;
      } else {
        title.textContent = 'âœ… çµæŸå·¥ä½œ?';
        workOrder.textContent = `å·¥å–®è™Ÿ: ${workOrderNo}`;
        time.textContent = `çµæŸæ™‚é–“: ${timeStr}`;
      }

      employee.textContent = `æ“ä½œå“¡: ${currentUser.empName} (${currentUser.empId})`;
      modal.classList.add('show');
    }

    function confirmAction(confirmed) {
      const modal = document.getElementById('modal');
      modal.classList.remove('show');

      if (!confirmed || !currentScan) {
        currentScan = null;
        return;
      }

      const now = new Date();
      const { workOrderNo, isStart } = currentScan;

      if (isStart) {
        workRecords.push({
          workOrderNo: workOrderNo,
          empId: currentUser.empId,
          empName: currentUser.empName,
          deptCode: currentUser.deptCode,
          startTime: now.toISOString(),
          endTime: null,
          duration: null
        });
        
        alert(`âœ“ å·²è¨˜éŒ„å·¥å–® ${workOrderNo} é–‹å§‹æ™‚é–“`);
      } else {
        const record = workRecords.find(r => 
          r.workOrderNo === workOrderNo && !r.endTime
        );
        
        if (record) {
          record.endTime = now.toISOString();
          
          const start = new Date(record.startTime);
          const end = new Date(record.endTime);
          const durationMs = end - start;
          const hours = Math.floor(durationMs / 3600000);
          const minutes = Math.floor((durationMs % 3600000) / 60000);
          record.duration = `${hours}å°æ™‚${minutes}åˆ†é˜`;
          
          alert(`âœ“ å·²è¨˜éŒ„å·¥å–® ${workOrderNo} çµæŸæ™‚é–“\nå·¥ä½œæ™‚é•·: ${record.duration}`);
        }
      }

      saveData();
      displayRecords();
      currentScan = null;
    }

    // ========== å·¥ä½œè¨˜éŒ„ ==========
    function displayRecords() {
      const container = document.getElementById('recordsTable');
      
      if (workRecords.length === 0) {
        container.innerHTML = '<div class="empty-state">å°šç„¡å·¥ä½œè¨˜éŒ„</div>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>å·¥å–®è™Ÿ</th>
              <th>å“¡å·¥</th>
              <th>éƒ¨é–€</th>
              <th>é–‹å§‹æ™‚é–“</th>
              <th>çµæŸæ™‚é–“</th>
              <th>å·¥ä½œæ™‚é•·</th>
              <th>ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (let i = workRecords.length - 1; i >= 0; i--) {
        const record = workRecords[i];
        const status = record.endTime ? 'âœ… å·²å®Œæˆ' : 'â³ é€²è¡Œä¸­';
        
        html += `
          <tr>
            <td><strong>${record.workOrderNo}</strong></td>
            <td>${record.empName}<br><small>${record.empId}</small></td>
            <td>${record.deptCode}</td>
            <td>${formatDateTime(new Date(record.startTime))}</td>
            <td>${record.endTime ? formatDateTime(new Date(record.endTime)) : '-'}</td>
            <td>${record.duration || '-'}</td>
            <td>${status}</td>
          </tr>
        `;
      }

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // ========== è³‡æ–™å„²å­˜ ==========
    function loadData() {
      const savedRecords = localStorage.getItem('workRecords');
      const savedBarcodes = localStorage.getItem('generatedBarcodes');
      const savedEmpBarcodes = localStorage.getItem('employeeBarcodes');
      const savedUser = localStorage.getItem('currentUser');
      
      if (savedRecords) {
        workRecords = JSON.parse(savedRecords);
      }
      if (savedBarcodes) {
        generatedBarcodes = JSON.parse(savedBarcodes);
        displayBarcodes();
      }
      if (savedEmpBarcodes) {
        employeeBarcodes = JSON.parse(savedEmpBarcodes);
      }
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        updateUserDisplay();
      }
    }

    function saveData() {
      localStorage.setItem('workRecords', JSON.stringify(workRecords));
      localStorage.setItem('generatedBarcodes', JSON.stringify(generatedBarcodes));
      localStorage.setItem('employeeBarcodes', JSON.stringify(employeeBarcodes));
    }

    // ========== Excel åŒ¯å‡º ==========
    function exportToExcel() {
      if (workRecords.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º!');
        return;
      }

      const data = workRecords.map(record => ({
        'å·¥å–®è™Ÿ': record.workOrderNo,
        'å“¡å·¥å·¥è™Ÿ': record.empId,
        'å“¡å·¥å§“å': record.empName,
        'éƒ¨é–€': record.deptCode,
        'é–‹å§‹æ™‚é–“': formatDateTime(new Date(record.startTime)),
        'çµæŸæ™‚é–“': record.endTime ? formatDateTime(new Date(record.endTime)) : 'å°šæœªçµæŸ',
        'å·¥ä½œæ™‚é•·': record.duration || 'è¨ˆç®—ä¸­',
        'ç‹€æ…‹': record.endTime ? 'å·²å®Œæˆ' : 'é€²è¡Œä¸­'
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      ws['!cols'] = [
        { wch: 15 },
        { wch: 12 },
        { wch: 12 },
        { wch: 10 },
        { wch: 20 },
        { wch: 20 },
        { wch: 15 },
        { wch: 10 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "å·¥ä½œè¨˜éŒ„");

      const filename = `å·¥å–®è¨˜éŒ„_${formatDateTime(new Date()).replace(/[: ]/g, '_')}.xlsx`;
      XLSX.writeFile(wb, filename);

      alert('âœ“ Excel æª”æ¡ˆå·²ä¸‹è¼‰!');
    }

    function clearData() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!')) {
        workRecords = [];
        saveData();
        displayRecords();
        alert('âœ“ å·²æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„');
      }
    }

    // ========== åˆå§‹åŒ– ==========
    window.onload = function() {
      loadData();
    };

    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        currentScan = null;
      }
    });

    window.addEventListener('beforeunload', function() {
      if (isScanning && html5QrCode) {
        html5QrCode.stop();
      }
      if (isEmployeeScanning && employeeScanner) {
        employeeScanner.stop();
      }
    });
  </script>
</body>
</html>
