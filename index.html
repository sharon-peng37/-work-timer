<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥å–®è¨ˆæ™‚ç³»çµ± - æ¸¬è©¦ç‰ˆ</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }

    .tab {
      padding: 15px 30px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-start {
      background: #4CAF50;
      color: white;
    }

    .btn-start:hover {
      background: #45a049;
    }

    .btn-stop {
      background: #f44336;
      color: white;
    }

    .btn-stop:hover {
      background: #da190b;
    }

    .btn-export {
      background: #2196F3;
      color: white;
    }

    .btn-export:hover {
      background: #0b7dda;
    }

    .btn-clear {
      background: #ff9800;
      color: white;
    }

    #reader {
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .status {
      padding: 15px;
      background: #f0f0f0;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .status.scanning {
      background: #fff3cd;
      color: #856404;
    }

    /* æ¢ç¢¼ç”Ÿæˆå€ */
    .barcode-generator {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .barcode-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .barcode-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #ddd;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .barcode-item h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .barcode-item svg {
      margin: 15px 0;
    }

    .barcode-item button {
      width: 100%;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: #667eea;
      color: white;
      font-weight: bold;
    }

    tr:hover {
      background: #f5f5f5;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal h2 {
      margin-bottom: 20px;
      color: #333;
    }

    .modal p {
      font-size: 18px;
      margin: 15px 0;
      color: #666;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      justify-content: center;
    }

    .modal button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .print-area {
      display: none;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .print-area, .print-area * {
        visibility: visible;
      }
      .print-area {
        position: absolute;
        left: 0;
        top: 0;
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ å·¥å–®è¨ˆæ™‚ç³»çµ±</h1>
    <p class="subtitle">æ¸¬è©¦ç‰ˆ - å«æ¢ç¢¼ç”Ÿæˆå™¨</p>

    <!-- åˆ†é æ¨™ç±¤ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('generate')">ğŸ·ï¸ ç”Ÿæˆæ¢ç¢¼</button>
      <button class="tab" onclick="switchTab('scan')">ğŸ“· æƒæè¨ˆæ™‚</button>
      <button class="tab" onclick="switchTab('records')">ğŸ“Š å·¥ä½œè¨˜éŒ„</button>
    </div>

    <!-- åˆ†é  1: ç”Ÿæˆæ¢ç¢¼ -->
    <div id="generate" class="tab-content active">
      <div class="barcode-generator">
        <h2>ç”¢ç”Ÿæ¸¬è©¦æ¢ç¢¼</h2>
        <div class="form-group">
          <label>å·¥å–®è™Ÿç¢¼:</label>
          <input type="text" id="workOrderInput" placeholder="ä¾‹å¦‚: WO20240204001">
        </div>
        <button class="btn-primary" onclick="generateBarcode()">ç”Ÿæˆæ¢ç¢¼</button>
        <button class="btn-primary" onclick="generateMultiple()">ç”Ÿæˆ5å€‹æ¸¬è©¦æ¢ç¢¼</button>
      </div>

      <div id="barcodeList" class="barcode-list"></div>
    </div>

    <!-- åˆ†é  2: æƒæè¨ˆæ™‚ -->
    <div id="scan" class="tab-content">
      <div class="controls">
        <button class="btn-start" onclick="startScanner()">ğŸ¥ é–‹å§‹æƒæ</button>
        <button class="btn-stop" onclick="stopScanner()">â¹ï¸ åœæ­¢æƒæ</button>
      </div>

      <div class="status" id="status">è«‹é»æ“Šã€Œé–‹å§‹æƒæã€</div>
      <div id="reader"></div>
    </div>

    <!-- åˆ†é  3: å·¥ä½œè¨˜éŒ„ -->
    <div id="records" class="tab-content">
      <div class="controls">
        <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
        <button class="btn-clear" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™</button>
      </div>
      <div id="recordsTable"></div>
    </div>
  </div>

  <!-- ç¢ºèªå°è©±æ¡† -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h2 id="modalTitle"></h2>
      <p id="modalWorkOrder"></p>
      <p id="modalTime"></p>
      <div class="modal-buttons">
        <button class="btn-start" onclick="confirmAction(true)">âœ“ ç¢ºèª</button>
        <button class="btn-stop" onclick="confirmAction(false)">âœ— å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- åˆ—å°å€åŸŸ -->
  <div class="print-area" id="printArea"></div>

  <script>
    let html5QrCode;
    let workRecords = [];
    let currentScan = null;
    let generatedBarcodes = [];

    // ========== åˆ†é åˆ‡æ› ==========
    function switchTab(tabName) {
      // éš±è—æ‰€æœ‰åˆ†é 
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // é¡¯ç¤ºé¸ä¸­çš„åˆ†é 
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      // å¦‚æœåˆ‡æ›åˆ°è¨˜éŒ„é ,æ›´æ–°é¡¯ç¤º
      if (tabName === 'records') {
        displayRecords();
      }
    }

    // ========== æ¢ç¢¼ç”Ÿæˆ ==========
    function generateBarcode() {
      const input = document.getElementById('workOrderInput');
      const workOrderNo = input.value.trim();

      if (!workOrderNo) {
        alert('è«‹è¼¸å…¥å·¥å–®è™Ÿ!');
        return;
      }

      addBarcodeToList(workOrderNo);
      input.value = '';
    }

    function generateMultiple() {
      const today = new Date();
      const dateStr = today.getFullYear() + 
                     String(today.getMonth() + 1).padStart(2, '0') + 
                     String(today.getDate()).padStart(2, '0');

      for (let i = 1; i <= 5; i++) {
        const workOrderNo = `WO${dateStr}${String(i).padStart(3, '0')}`;
        addBarcodeToList(workOrderNo);
      }
    }

    function addBarcodeToList(workOrderNo) {
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
      if (generatedBarcodes.includes(workOrderNo)) {
        alert('æ­¤å·¥å–®è™Ÿå·²ç¶“ç”Ÿæˆéäº†!');
        return;
      }

      generatedBarcodes.push(workOrderNo);
      displayBarcodes();
    }

    function displayBarcodes() {
      const container = document.getElementById('barcodeList');
      
      if (generatedBarcodes.length === 0) {
        container.innerHTML = '<div class="empty-state">å°šæœªç”Ÿæˆä»»ä½•æ¢ç¢¼</div>';
        return;
      }

      container.innerHTML = '';

      generatedBarcodes.forEach((workOrderNo, index) => {
        const div = document.createElement('div');
        div.className = 'barcode-item';
        div.innerHTML = `
          <h3>å·¥å–® #${index + 1}</h3>
          <svg id="barcode-${index}"></svg>
          <p><strong>${workOrderNo}</strong></p>
          <button class="btn-primary" onclick="printBarcode(${index})">ğŸ–¨ï¸ åˆ—å°æ­¤æ¢ç¢¼</button>
          <button class="btn-stop" onclick="removeBarcode(${index})">ğŸ—‘ï¸ åˆªé™¤</button>
        `;
        container.appendChild(div);

        // ç”Ÿæˆæ¢ç¢¼
        JsBarcode(`#barcode-${index}`, workOrderNo, {
          format: "CODE128",
          width: 2,
          height: 80,
          displayValue: true,
          fontSize: 16,
          margin: 10
        });
      });
    }

    function removeBarcode(index) {
      generatedBarcodes.splice(index, 1);
      displayBarcodes();
    }

    function printBarcode(index) {
      const workOrderNo = generatedBarcodes[index];
      const printArea = document.getElementById('printArea');
      
      printArea.innerHTML = `
        <div style="text-align: center; padding: 50px;">
          <h2>${workOrderNo}</h2>
          <svg id="print-barcode"></svg>
        </div>
      `;

      JsBarcode('#print-barcode', workOrderNo, {
        format: "CODE128",
        width: 3,
        height: 100,
        displayValue: true,
        fontSize: 20,
        margin: 20
      });

      window.print();
    }

    // ========== æƒæåŠŸèƒ½ ==========
    function startScanner() {
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'æƒæä¸­...è«‹å°æº–æ¢ç¢¼';
      statusEl.className = 'status scanning';

      html5QrCode = new Html5Qrcode("reader");
      
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 300, height: 150 }
        },
        onScanSuccess,
        onScanError
      ).catch(err => {
        alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + err);
        statusEl.textContent = 'ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—';
        statusEl.className = 'status';
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById('status').textContent = 'å·²åœæ­¢æƒæ';
          document.getElementById('status').className = 'status';
        });
      }
    }

    function onScanSuccess(decodedText) {
      console.log("æƒæåˆ°:", decodedText);
      
      // åœæ­¢æƒæ
      stopScanner();
      
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ­¤å·¥å–®çš„é–‹å§‹è¨˜éŒ„
      const existingRecord = workRecords.find(r => 
        r.workOrderNo === decodedText && !r.endTime
      );

      currentScan = {
        workOrderNo: decodedText,
        isStart: !existingRecord
      };

      showModal(decodedText, !existingRecord);
    }

    function onScanError(error) {
      // å¿½ç•¥æƒæéŒ¯èª¤(æŒçºŒæƒæä¸­)
    }

    // ========== å°è©±æ¡† ==========
    function showModal(workOrderNo, isStart) {
      const modal = document.getElementById('modal');
      const title = document.getElementById('modalTitle');
      const workOrder = document.getElementById('modalWorkOrder');
      const time = document.getElementById('modalTime');

      const now = new Date();
      const timeStr = formatDateTime(now);

      if (isStart) {
        title.textContent = 'â±ï¸ é–‹å§‹å·¥ä½œ?';
        workOrder.textContent = `å·¥å–®è™Ÿ: ${workOrderNo}`;
        time.textContent = `é–‹å§‹æ™‚é–“: ${timeStr}`;
      } else {
        title.textContent = 'âœ… çµæŸå·¥ä½œ?';
        workOrder.textContent = `å·¥å–®è™Ÿ: ${workOrderNo}`;
        time.textContent = `çµæŸæ™‚é–“: ${timeStr}`;
      }

      modal.classList.add('show');
    }

    function confirmAction(confirmed) {
      const modal = document.getElementById('modal');
      modal.classList.remove('show');

      if (!confirmed || !currentScan) {
        currentScan = null;
        return;
      }

      const now = new Date();
      const { workOrderNo, isStart } = currentScan;

      if (isStart) {
        // æ–°å¢é–‹å§‹è¨˜éŒ„
        workRecords.push({
          workOrderNo: workOrderNo,
          startTime: now.toISOString(),
          endTime: null,
          duration: null
        });
        
        alert(`âœ“ å·²è¨˜éŒ„å·¥å–® ${workOrderNo} é–‹å§‹æ™‚é–“`);
      } else {
        // æ›´æ–°çµæŸæ™‚é–“
        const record = workRecords.find(r => 
          r.workOrderNo === workOrderNo && !r.endTime
        );
        
        if (record) {
          record.endTime = now.toISOString();
          
          // è¨ˆç®—å·¥ä½œæ™‚é•·
          const start = new Date(record.startTime);
          const end = new Date(record.endTime);
          const durationMs = end - start;
          const hours = Math.floor(durationMs / 3600000);
          const minutes = Math.floor((durationMs % 3600000) / 60000);
          record.duration = `${hours}å°æ™‚${minutes}åˆ†é˜`;
          
          alert(`âœ“ å·²è¨˜éŒ„å·¥å–® ${workOrderNo} çµæŸæ™‚é–“\nå·¥ä½œæ™‚é•·: ${record.duration}`);
        }
      }

      saveData();
      displayRecords();
      currentScan = null;
    }

    // ========== è¨˜éŒ„ç®¡ç† ==========
    function displayRecords() {
      const container = document.getElementById('recordsTable');
      
      if (workRecords.length === 0) {
        container.innerHTML = '<div class="empty-state">å°šç„¡å·¥ä½œè¨˜éŒ„</div>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>å·¥å–®è™Ÿ</th>
              <th>é–‹å§‹æ™‚é–“</th>
              <th>çµæŸæ™‚é–“</th>
              <th>å·¥ä½œæ™‚é•·</th>
              <th>ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody>
      `;

      // åå‘é¡¯ç¤º(æœ€æ–°çš„åœ¨ä¸Šé¢)
      for (let i = workRecords.length - 1; i >= 0; i--) {
        const record = workRecords[i];
        const status = record.endTime ? 'âœ… å·²å®Œæˆ' : 'â³ é€²è¡Œä¸­';
        
        html += `
          <tr>
            <td><strong>${record.workOrderNo}</strong></td>
            <td>${formatDateTime(new Date(record.startTime))}</td>
            <td>${record.endTime ? formatDateTime(new Date(record.endTime)) : '-'}</td>
            <td>${record.duration || '-'}</td>
            <td>${status}</td>
          </tr>
        `;
      }

      html += `
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // ========== è³‡æ–™å„²å­˜ ==========
    function loadData() {
      const savedRecords = localStorage.getItem('workRecords');
      const savedBarcodes = localStorage.getItem('generatedBarcodes');
      
      if (savedRecords) {
        workRecords = JSON.parse(savedRecords);
      }
      if (savedBarcodes) {
        generatedBarcodes = JSON.parse(savedBarcodes);
        displayBarcodes();
      }
    }

    function saveData() {
      localStorage.setItem('workRecords', JSON.stringify(workRecords));
      localStorage.setItem('generatedBarcodes', JSON.stringify(generatedBarcodes));
    }

    // ========== Excel åŒ¯å‡º ==========
    function exportToExcel() {
      if (workRecords.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º!');
        return;
      }

      const data = workRecords.map(record => ({
        'å·¥å–®è™Ÿ': record.workOrderNo,
        'é–‹å§‹æ™‚é–“': formatDateTime(new Date(record.startTime)),
        'çµæŸæ™‚é–“': record.endTime ? formatDateTime(new Date(record.endTime)) : 'å°šæœªçµæŸ',
        'å·¥ä½œæ™‚é•·': record.duration || 'è¨ˆç®—ä¸­',
        'ç‹€æ…‹': record.endTime ? 'å·²å®Œæˆ' : 'é€²è¡Œä¸­'
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      ws['!cols'] = [
        { wch: 15 },
        { wch: 20 },
        { wch: 20 },
        { wch: 15 },
        { wch: 10 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "å·¥ä½œè¨˜éŒ„");

      const filename = `å·¥å–®è¨˜éŒ„_${formatDateTime(new Date()).replace(/[: ]/g, '_')}.xlsx`;
      XLSX.writeFile(wb, filename);

      alert('âœ“ Excel æª”æ¡ˆå·²ä¸‹è¼‰!');
    }

    function clearData() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!')) {
        workRecords = [];
        saveData();
        displayRecords();
        alert('âœ“ å·²æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„');
      }
    }

    // ========== åˆå§‹åŒ– ==========
    window.onload = function() {
      loadData();
    };

    // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        currentScan = null;
      }
    });
  </script>
</body>
</html>
